
<%- include('../Partials/user/LandingPage/header', { title: 'ChapterOne | Discover Your Story' }) %>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Open+Sans:wght@300;400;600&display=swap');

    :root {
        --primary-brown: #5D4037;
        --secondary-brown: #795548;
        --accent-cream: #F4ECD8;
        --text-color: #3E2723;
        --soft-shadow: rgba(0,0,0,0.1);
    }

    * {
        transition: all 0.3s ease;
    }

    body {
        font-family: 'Open Sans', sans-serif;
        background-color: var(--accent-cream);
        color: var(--text-color);
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .navbar {
        background-color: white;
        box-shadow: 0 2px 10px var(--soft-shadow);
        padding: 15px 0;
    }

    .navbar-brand {
        font-family: 'Playfair Display', serif;
        color: var(--primary-brown);
        font-weight: 700;
        font-size: 2rem;
        letter-spacing: 1px;
    }

    .navbar-nav .nav-link {
        color: var(--secondary-brown);
        font-weight: 600;
        position: relative;
        margin-right: 15px;
    }

    .navbar-nav .nav-link::after {
        content: '';
        position: absolute;
        width: 0;
        height: 2px;
        bottom: -5px;
        left: 0;
        background-color: var(--primary-brown);
        transition: width 0.3s;
    }

    .navbar-nav .nav-link:hover::after {
        width: 100%;
    }

    .forgot-password-container {
        background-color: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 10px 30px var(--soft-shadow);
        max-width: 500px;
        margin: 0 auto;
    }

    .page-title {
        font-family: 'Playfair Display', serif;
        color: var(--primary-brown);
        font-weight: 700;
        margin-bottom: 20px;
    }

    .form-control {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .form-control:focus {
        border-color: var(--primary-brown);
        box-shadow: 0 0 0 0.2rem rgba(93, 64, 55, 0.25);
    }

    .btn-submit {
        background-color: var(--primary-brown);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        font-weight: 600;
        width: 100%;
        margin-top: 10px;
    }

    .btn-submit:hover {
        background-color: var(--secondary-brown);
    }

    .btn-back {
        color: var(--primary-brown);
        text-decoration: none;
        display: inline-block;
        margin-top: 20px;
        font-weight: 600;
    }

    .btn-back:hover {
        color: var(--secondary-brown);
    }

    .footer {
        background-color: var(--primary-brown);
        color: white;
        padding: 30px 0;
        margin-top: auto;
    }

    .footer a {
        color: var(--accent-cream);
        text-decoration: none;
        margin-right: 15px;
        transition: color 0.3s ease;
    }

    .footer a:hover {
        color: white;
    }
    
    .info-text {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 20px;
    }
    
    .icon-lock {
        font-size: 3rem;
        color: var(--primary-brown);
        margin-bottom: 20px;
    }
    
    .content-section {
        padding: 120px 0 80px;
        flex: 1;
    }
    
    /* Custom SweetAlert Theme */
    .themed-swal .swal2-title {
        font-family: 'Playfair Display', serif;
        color: var(--primary-brown);
    }
    
    .themed-swal .swal2-content {
        font-family: 'Open Sans', sans-serif;
    }
    
    .themed-swal .swal2-confirm {
        background-color: var(--primary-brown) !important;
    }
    
    .themed-swal .swal2-icon.swal2-error {
        border-color: var(--primary-brown) !important;
    }
    
    .themed-swal .swal2-icon.swal2-error [class^=swal2-x-mark-line] {
        background-color: var(--primary-brown) !important;
    }
    
    .themed-swal .swal2-icon.swal2-success {
        border-color: var(--secondary-brown) !important;
    }
    
    .themed-swal .swal2-icon.swal2-success [class^=swal2-success-line] {
        background-color: var(--secondary-brown) !important;
    }
    
    .themed-swal .swal2-icon.swal2-success .swal2-success-ring {
        border-color: var(--secondary-brown) !important;
    }
    
    /* Loading spinner */
    .spinner {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .btn-submit.loading {
        display: flex;
        justify-content: center;
        align-items: center;
    }
</style>

<section class="content-section">
    <div class="container">
        <div class="forgot-password-container text-center">
            <div class="icon-lock">
                <i class="fas fa-unlock-alt"></i>
            </div>
            <h2 class="page-title">Forgot Your Password?</h2>
            <p class="info-text">Enter your email address below and we'll send you a one-time password (OTP) to reset your password.</p>
            
            <form id="forgotPasswordForm">
                <div class="mb-4">
                    <input name="email" type="email" class="form-control" placeholder="Email Address" required>
                </div>
                <button type="submit" id="submitBtn" class="btn btn-submit">Send Reset OTP</button>
            </form>
            
            <a href="/login" class="btn-back">
                <i class="fas fa-arrow-left me-2"></i>Back to Sign In
            </a>
        </div>
    </div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.3/sweetalert2.all.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('forgotPasswordForm');
    const submitBtn = document.getElementById('submitBtn');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        const email = form.querySelector('input[name="email"]').value;
        
        // Validate email
        if (!email || !isValidEmail(email)) {
            showAlert('error', 'Invalid Email', 'Please enter a valid email address.');
            return;
        }
        
        // Show loading state
        submitBtn.innerHTML = '<span class="spinner"></span> Processing...';
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;
        
        // Make fetch request
        fetch('/forgot-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ email })
        })
        .then(response => {
            return response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.message || 'Something went wrong');
                }
                return data;
            });
        })
        .then(data => {
            // Success
            showAlert('success', 'Email Sent!', 'We\'ve sent an OTP to your email address. Please check your inbox to reset your password.');
            form.reset();
            
            // If there's a redirect URL in the response, navigate to it
            if (data.redirect) {
                setTimeout(() => {
                    window.location.href = data.redirect;
                }, 2000);
            }
        })
        .catch(error => {
            // Error
            showAlert('error', 'Error', error.message);
            console.error('Error:', error);
        })
        .finally(() => {
            // Reset button state
            submitBtn.innerHTML = 'Send Reset OTP';
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
        });
    });
    
    // Email validation function
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
    
    // Sweet Alert themed function
    function showAlert(icon, title, text) {
        Swal.fire({
            icon: icon,
            title: title,
            text: text,
            customClass: {
                container: 'themed-swal',
                popup: 'themed-swal',
                header: 'themed-swal',
                title: 'themed-swal',
                closeButton: 'themed-swal',
                icon: 'themed-swal',
                image: 'themed-swal',
                content: 'themed-swal',
                input: 'themed-swal',
                actions: 'themed-swal',
                confirmButton: 'themed-swal',
                cancelButton: 'themed-swal',
                footer: 'themed-swal'
            },
            buttonsStyling: true,
            confirmButtonColor: '#5D4037'
        });
    }
});
</script>

<%- include('../Partials/user/LandingPage/footer') %>